<!doctype html>
<html>
<head>
<meta charset='UTF-8'><meta name='viewport' content='width=device-width initial-scale=1'><style type='text/css'>html {overflow-x: initial !important;}</style>
<style type='text/css'  id="style-base">:root { --bg-color: #ffffff; --text-color: #333333; --select-text-bg-color: #B5D6FC; --select-text-font-color: auto; --monospace: "Lucida Console",Consolas,"Courier",monospace; --title-bar-height: 20px; }
.mac-os-11 { --title-bar-height: 28px; }
html { font-size: 14px; background-color: var(--bg-color); color: var(--text-color); font-family: "Helvetica Neue", Helvetica, Arial, "Segoe UI Emoji", "SF Pro", sans-serif; -webkit-font-smoothing: antialiased; }
h1, h2, h3, h4, h5 { white-space: pre-wrap; }
body { margin: 0px; padding: 0px; height: auto; inset: 0px; font-size: 1rem; line-height: 1.42857; overflow-x: hidden; background: inherit; }
iframe { margin: auto; }
a.url { word-break: break-all; }
a:active, a:hover { outline: 0px; }
.in-text-selection, ::selection { text-shadow: none; background: var(--select-text-bg-color); color: var(--select-text-font-color); }
#write { margin: 0px auto; height: auto; width: inherit; word-break: normal; overflow-wrap: break-word; position: relative; white-space: normal; overflow-x: visible; padding-top: 36px; }
#write.first-line-indent p { text-indent: 2em; }
#write.first-line-indent li p, #write.first-line-indent p *, #write.first-line-indent svg * { text-indent: 0px; }
#write.first-line-indent li { margin-left: 2em; }
.for-image #write { padding-left: 8px; padding-right: 8px; }
body.typora-export { padding-left: 30px; padding-right: 30px; }
.typora-export .footnote-line, .typora-export li, .typora-export p { white-space: pre-wrap; }
.typora-export .task-list-item input { pointer-events: none; }
@media screen and (max-width: 500px) {
  body.typora-export { padding-left: 0px; padding-right: 0px; }
  #write { padding-left: 20px; padding-right: 20px; }
}
#write li > figure:last-child { margin-bottom: 0.5rem; }
#write ol, #write ul { position: relative; }
img { max-width: 100%; vertical-align: middle; image-orientation: from-image; }
button, input, select, textarea { color: inherit; font: inherit; }
input[type="checkbox"], input[type="radio"] { line-height: normal; padding: 0px; }
*, ::after, ::before { box-sizing: border-box; }
#write h1, #write h2, #write h3, #write h4, #write h5, #write h6, #write p, #write pre { width: inherit; position: relative; }
#write svg h1, #write svg h2, #write svg h3, #write svg h4, #write svg h5, #write svg h6, #write svg p { position: static; }
.nodeLabel p { padding-right: 2px; padding-left: 2px; }
.typora-export .nodeLabel p { padding-right: 0px; padding-left: 0px; }
foreignobject { overflow: visible; }
p { line-height: inherit; }
h1, h2, h3, h4, h5, h6 { break-after: avoid-page; break-inside: avoid; orphans: 4; }
p { orphans: 4; }
li p { orphans: 1; }
h1 { font-size: 2rem; }
h2 { font-size: 1.8rem; }
h3 { font-size: 1.6rem; }
h4 { font-size: 1.4rem; }
h5 { font-size: 1.2rem; }
h6 { font-size: 1rem; }
.md-math-block, .md-rawblock, h1, h2, h3, h4, h5, h6, p { margin-top: 1rem; margin-bottom: 1rem; }
.hidden { display: none; }
.md-blockmeta { color: rgb(204, 204, 204); font-weight: 700; font-style: italic; }
a { cursor: pointer; }
sup.md-footnote { padding: 2px 4px; background-color: rgba(238, 238, 238, 0.7); color: rgb(85, 85, 85); border-radius: 4px; cursor: pointer; }
sup.md-footnote a, sup.md-footnote a:hover { color: inherit; text-transform: inherit; text-decoration: inherit; }
#write input[type="checkbox"] { cursor: pointer; width: inherit; height: inherit; }
figure { overflow-x: auto; margin: 1.2em 0px; max-width: calc(100% + 16px); padding: 0px; }
figure > table { margin: 0px; }
thead, tr { break-inside: avoid; break-after: auto; }
thead { display: table-header-group; }
table { border-collapse: collapse; border-spacing: 0px; width: 100%; overflow: auto; break-inside: auto; text-align: left; }
table.md-table td { min-width: 32px; }
.CodeMirror-gutters { border-right: 0px; background-color: inherit; }
.CodeMirror-linenumber { user-select: none; }
.CodeMirror { text-align: left; }
.CodeMirror-placeholder { opacity: 0.3; }
.CodeMirror pre { padding: 0px 4px; }
.CodeMirror-lines { padding: 0px; }
div.hr:focus { cursor: none; }
#write pre { white-space: pre-wrap; }
#write.fences-no-line-wrapping pre { white-space: pre; }
#write pre.ty-contain-cm { white-space: normal; }
.CodeMirror-gutters { margin-right: 4px; }
.md-fences { font-size: 0.9rem; display: block; break-inside: avoid; text-align: left; overflow: visible; white-space: pre; background: inherit; position: relative !important; }
.md-fences-adv-panel { width: 100%; margin-top: 10px; text-align: center; padding-top: 0px; padding-bottom: 8px; overflow-x: auto; }
#write .md-fences.mock-cm { white-space: pre-wrap; }
.md-fences.md-fences-with-lineno { padding-left: 0px; }
#write.fences-no-line-wrapping .md-fences.mock-cm { white-space: pre; overflow-x: auto; }
.md-fences.mock-cm.md-fences-with-lineno { padding-left: 8px; }
.CodeMirror-line, twitterwidget { break-inside: avoid; }
svg { break-inside: avoid; }
.footnotes { opacity: 0.8; font-size: 0.9rem; margin-top: 1em; margin-bottom: 1em; }
.footnotes + .footnotes { margin-top: 0px; }
.md-reset { margin: 0px; padding: 0px; border: 0px; outline: 0px; vertical-align: top; background: 0px 0px; text-decoration: none; text-shadow: none; float: none; position: static; width: auto; height: auto; white-space: nowrap; cursor: inherit; -webkit-tap-highlight-color: transparent; line-height: normal; font-weight: 400; text-align: left; box-sizing: content-box; direction: ltr; }
li div { padding-top: 0px; }
blockquote { margin: 1rem 0px; }
li .mathjax-block, li p { margin: 0.5rem 0px; }
li blockquote { margin: 1rem 0px; }
li { margin: 0px; position: relative; }
blockquote > :last-child { margin-bottom: 0px; }
blockquote > :first-child, li > :first-child { margin-top: 0px; }
.footnotes-area { color: rgb(136, 136, 136); margin-top: 0.714rem; padding-bottom: 0.143rem; white-space: normal; }
#write .footnote-line { white-space: pre-wrap; }
@media print {
  body, html { border: 1px solid transparent; height: 99%; break-after: avoid; break-before: avoid; font-variant-ligatures: no-common-ligatures; }
  #write { margin-top: 0px; border-color: transparent !important; padding-top: 0px !important; padding-bottom: 0px !important; }
  .typora-export * { -webkit-print-color-adjust: exact; }
  .typora-export #write { break-after: avoid; }
  .typora-export #write::after { height: 0px; }
  .is-mac table { break-inside: avoid; }
  #write > p:nth-child(1) { margin-top: 0px; }
  .typora-export-show-outline .typora-export-sidebar { display: none; }
  figure { overflow-x: visible; }
}
.footnote-line { margin-top: 0.714em; font-size: 0.7em; }
a img, img a { cursor: pointer; }
pre.md-meta-block { font-size: 0.8rem; min-height: 0.8rem; white-space: pre-wrap; background: rgb(204, 204, 204); display: block; overflow-x: hidden; }
p > .md-image:only-child:not(.md-img-error) img, p > img:only-child { display: block; margin: auto; }
#write.first-line-indent p > .md-image:only-child:not(.md-img-error) img { left: -2em; position: relative; }
p > .md-image:only-child { display: inline-block; width: 100%; }
#write .MathJax_Display { margin: 0.8em 0px 0px; }
.md-math-block { width: 100%; }
.md-math-block:not(:empty)::after { display: none; }
.MathJax_ref { fill: currentcolor; }
[contenteditable="true"]:active, [contenteditable="true"]:focus, [contenteditable="false"]:active, [contenteditable="false"]:focus { outline: 0px; box-shadow: none; }
.md-task-list-item { position: relative; list-style-type: none; }
.task-list-item.md-task-list-item { padding-left: 0px; }
.md-task-list-item > input { position: absolute; top: 0px; left: 0px; margin-left: -1.2em; margin-top: calc(1em - 10px); border: none; }
.math { font-size: 1rem; }
.md-toc { min-height: 3.58rem; position: relative; font-size: 0.9rem; border-radius: 10px; }
.md-toc-content { position: relative; margin-left: 0px; }
.md-toc-content::after, .md-toc::after { display: none; }
.md-toc-item { display: block; color: rgb(65, 131, 196); }
.md-toc-item a { text-decoration: none; }
.md-toc-inner:hover { text-decoration: underline; }
.md-toc-inner { display: inline-block; cursor: pointer; }
.md-toc-h1 .md-toc-inner { margin-left: 0px; font-weight: 700; }
.md-toc-h2 .md-toc-inner { margin-left: 2em; }
.md-toc-h3 .md-toc-inner { margin-left: 4em; }
.md-toc-h4 .md-toc-inner { margin-left: 6em; }
.md-toc-h5 .md-toc-inner { margin-left: 8em; }
.md-toc-h6 .md-toc-inner { margin-left: 10em; }
@media screen and (max-width: 48em) {
  .md-toc-h3 .md-toc-inner { margin-left: 3.5em; }
  .md-toc-h4 .md-toc-inner { margin-left: 5em; }
  .md-toc-h5 .md-toc-inner { margin-left: 6.5em; }
  .md-toc-h6 .md-toc-inner { margin-left: 8em; }
}
a.md-toc-inner { font-size: inherit; font-style: inherit; font-weight: inherit; line-height: inherit; }
.footnote-line a:not(.reversefootnote) { color: inherit; }
.reversefootnote { font-family: ui-monospace, sans-serif; }
.md-attr { display: none; }
.md-fn-count::after { content: "."; }
code, pre, samp, tt { font-family: var(--monospace); }
kbd { margin: 0px 0.1em; padding: 0.1em 0.6em; font-size: 0.8em; color: rgb(36, 39, 41); background: rgb(255, 255, 255); border: 1px solid rgb(173, 179, 185); border-radius: 3px; box-shadow: rgba(12, 13, 14, 0.2) 0px 1px 0px, rgb(255, 255, 255) 0px 0px 0px 2px inset; white-space: nowrap; vertical-align: middle; }
.md-comment { color: rgb(162, 127, 3); opacity: 0.6; font-family: var(--monospace); }
code { text-align: left; vertical-align: initial; }
a.md-print-anchor { white-space: pre !important; border-width: initial !important; border-style: none !important; border-color: initial !important; display: inline-block !important; position: absolute !important; width: 1px !important; right: 0px !important; outline: 0px !important; background: 0px 0px !important; text-decoration: initial !important; text-shadow: initial !important; }
.os-windows.monocolor-emoji .md-emoji { font-family: "Segoe UI Symbol", sans-serif; }
.md-diagram-panel > svg { max-width: 100%; }
[lang="flow"] svg, [lang="mermaid"] svg { max-width: 100%; height: auto; }
[lang="mermaid"] .node text { font-size: 1rem; }
table tr th { border-bottom: 0px; }
video { max-width: 100%; display: block; margin: 0px auto; }
iframe { max-width: 100%; width: 100%; border: none; }
.highlight td, .highlight tr { border: 0px; }
mark { background: rgb(255, 255, 0); color: rgb(0, 0, 0); }
.md-html-inline .md-plain, .md-html-inline strong, mark .md-inline-math, mark strong { color: inherit; }
.md-expand mark .md-meta { opacity: 0.3 !important; }
mark .md-meta { color: rgb(0, 0, 0); }
@media print {
  .typora-export h1, .typora-export h2, .typora-export h3, .typora-export h4, .typora-export h5, .typora-export h6 { break-inside: avoid; }
}
.md-diagram-panel .messageText { stroke: none !important; }
.md-diagram-panel .start-state { fill: var(--node-fill); }
.md-diagram-panel .edgeLabel rect { opacity: 1 !important; }
.md-fences.md-fences-math { font-size: 1em; }
.md-fences-advanced:not(.md-focus) { padding: 0px; white-space: nowrap; border: 0px; }
.md-fences-advanced:not(.md-focus) { background: inherit; }
.mermaid-svg { margin: auto; }
.typora-export-show-outline .typora-export-content { max-width: 1440px; margin: auto; display: flex; flex-direction: row; }
.typora-export-sidebar { width: 300px; font-size: 0.8rem; margin-top: 80px; margin-right: 18px; }
.typora-export-show-outline #write { --webkit-flex: 2; flex: 2 1 0%; }
.typora-export-sidebar .outline-content { position: fixed; top: 0px; max-height: 100%; overflow: hidden auto; padding-bottom: 30px; padding-top: 60px; width: 300px; }
@media screen and (max-width: 1024px) {
  .typora-export-sidebar, .typora-export-sidebar .outline-content { width: 240px; }
}
@media screen and (max-width: 800px) {
  .typora-export-sidebar { display: none; }
}
.outline-content li, .outline-content ul { margin-left: 0px; margin-right: 0px; padding-left: 0px; padding-right: 0px; list-style: none; overflow-wrap: anywhere; }
.outline-content ul { margin-top: 0px; margin-bottom: 0px; }
.outline-content strong { font-weight: 400; }
.outline-expander { width: 1rem; height: 1.42857rem; position: relative; display: table-cell; vertical-align: middle; cursor: pointer; padding-left: 4px; }
.outline-expander::before { content: "ÔÑ•"; position: relative; font-family: Ionicons; display: inline-block; font-size: 8px; vertical-align: middle; }
.outline-item { padding-top: 3px; padding-bottom: 3px; cursor: pointer; }
.outline-expander:hover::before { content: "ÔÑ£"; }
.outline-h1 > .outline-item { padding-left: 0px; }
.outline-h2 > .outline-item { padding-left: 1em; }
.outline-h3 > .outline-item { padding-left: 2em; }
.outline-h4 > .outline-item { padding-left: 3em; }
.outline-h5 > .outline-item { padding-left: 4em; }
.outline-h6 > .outline-item { padding-left: 5em; }
.outline-label { cursor: pointer; display: table-cell; vertical-align: middle; text-decoration: none; color: inherit; }
.outline-label:hover { text-decoration: underline; }
.outline-item:hover { border-color: rgb(245, 245, 245); background-color: var(--item-hover-bg-color); }
.outline-item:hover { margin-left: -28px; margin-right: -28px; border-left: 28px solid transparent; border-right: 28px solid transparent; }
.outline-item-single .outline-expander::before, .outline-item-single .outline-expander:hover::before { display: none; }
.outline-item-open > .outline-item > .outline-expander::before { content: "ÔÑ£"; }
.outline-children { display: none; }
.info-panel-tab-wrapper { display: none; }
.outline-item-open > .outline-children { display: block; }
.typora-export .outline-item { padding-top: 1px; padding-bottom: 1px; }
.typora-export .outline-item:hover { margin-right: -8px; border-right: 8px solid transparent; }
.typora-export .outline-expander::before { content: "+"; font-family: inherit; top: -1px; }
.typora-export .outline-expander:hover::before, .typora-export .outline-item-open > .outline-item > .outline-expander::before { content: "‚àí"; }
.typora-export-collapse-outline .outline-children { display: none; }
.typora-export-collapse-outline .outline-item-open > .outline-children, .typora-export-no-collapse-outline .outline-children { display: block; }
.typora-export-no-collapse-outline .outline-expander::before { content: "" !important; }
.typora-export-show-outline .outline-item-active > .outline-item .outline-label { font-weight: 700; }
.md-inline-math-container mjx-container { zoom: 0.95; }
mjx-container { break-inside: avoid; }
.md-alert.md-alert-note { border-left-color: rgb(9, 105, 218); }
.md-alert.md-alert-important { border-left-color: rgb(130, 80, 223); }
.md-alert.md-alert-warning { border-left-color: rgb(154, 103, 0); }
.md-alert.md-alert-tip { border-left-color: rgb(31, 136, 61); }
.md-alert.md-alert-caution { border-left-color: rgb(207, 34, 46); }
.md-alert { padding: 0px 1em; margin-bottom: 16px; color: inherit; border-left: 0.25em solid rgb(0, 0, 0); }
.md-alert-text-note { color: rgb(9, 105, 218); }
.md-alert-text-important { color: rgb(130, 80, 223); }
.md-alert-text-warning { color: rgb(154, 103, 0); }
.md-alert-text-tip { color: rgb(31, 136, 61); }
.md-alert-text-caution { color: rgb(207, 34, 46); }
.md-alert-text { font-size: 0.9rem; font-weight: 700; }
.md-alert-text svg { fill: currentcolor; position: relative; top: 0.125em; margin-right: 1ch; overflow: visible; }
.md-alert-text-container::after { content: attr(data-text); text-transform: capitalize; pointer-events: none; margin-right: 1ch; }

</style>
<link rel='stylesheet' href='https://fonts.googleapis.com/css?family=Open+Sans:400italic,700italic,700,400&amp;subset=latin,latin-ext' type='text/css' />
<style type='text/css'  id="style-theme_css">:root {
    --side-bar-bg-color: #fafafa;
    --control-text-color: #777;
}

@include-when-export url(https://fonts.googleapis.com/css?family=Open+Sans:400italic,700italic,700,400&subset=latin,latin-ext);

/* open-sans-regular - latin-ext_latin */
  /* open-sans-italic - latin-ext_latin */
    /* open-sans-700 - latin-ext_latin */
    /* open-sans-700italic - latin-ext_latin */
  html {
    font-size: 16px;
    -webkit-font-smoothing: antialiased;
}

body {
    font-family: "Open Sans","Clear Sans", "Helvetica Neue", Helvetica, Arial, 'Segoe UI Emoji', 'SF Pro', sans-serif;
    color: rgb(51, 51, 51);
    line-height: 1.6;
}

#write {
    max-width: 860px;
  	margin: 0 auto;
  	padding: 30px;
    padding-bottom: 100px;
}

@media only screen and (min-width: 1400px) {
	#write {
		max-width: 1024px;
	}
}

@media only screen and (min-width: 1800px) {
	#write {
		max-width: 1200px;
	}
}

#write > ul:first-child,
#write > ol:first-child{
    margin-top: 30px;
}

a {
    color: #4183C4;
}
h1,
h2,
h3,
h4,
h5,
h6 {
    position: relative;
    margin-top: 1rem;
    margin-bottom: 1rem;
    font-weight: bold;
    line-height: 1.4;
    cursor: text;
}
h1:hover a.anchor,
h2:hover a.anchor,
h3:hover a.anchor,
h4:hover a.anchor,
h5:hover a.anchor,
h6:hover a.anchor {
    text-decoration: none;
}
h1 tt,
h1 code {
    font-size: inherit;
}
h2 tt,
h2 code {
    font-size: inherit;
}
h3 tt,
h3 code {
    font-size: inherit;
}
h4 tt,
h4 code {
    font-size: inherit;
}
h5 tt,
h5 code {
    font-size: inherit;
}
h6 tt,
h6 code {
    font-size: inherit;
}
h1 {
    font-size: 2.25em;
    line-height: 1.2;
    border-bottom: 1px solid #eee;
}
h2 {
    font-size: 1.75em;
    line-height: 1.225;
    border-bottom: 1px solid #eee;
}

/*@media print {
    .typora-export h1,
    .typora-export h2 {
        border-bottom: none;
        padding-bottom: initial;
    }

    .typora-export h1::after,
    .typora-export h2::after {
        content: "";
        display: block;
        height: 100px;
        margin-top: -96px;
        border-top: 1px solid #eee;
    }
}*/

h3 {
    font-size: 1.5em;
    line-height: 1.43;
}
h4 {
    font-size: 1.25em;
}
h5 {
    font-size: 1em;
}
h6 {
   font-size: 1em;
    color: #777;
}
p,
blockquote,
ul,
ol,
dl,
table{
    margin: 0.8em 0;
}
li>ol,
li>ul {
    margin: 0 0;
}
hr {
    height: 2px;
    padding: 0;
    margin: 16px 0;
    background-color: #e7e7e7;
    border: 0 none;
    overflow: hidden;
    box-sizing: content-box;
}

li p.first {
    display: inline-block;
}
ul,
ol {
    padding-left: 30px;
}
ul:first-child,
ol:first-child {
    margin-top: 0;
}
ul:last-child,
ol:last-child {
    margin-bottom: 0;
}
blockquote {
    border-left: 4px solid #dfe2e5;
    padding: 0 15px;
    color: #777777;
}
blockquote blockquote {
    padding-right: 0;
}
table {
    padding: 0;
    word-break: initial;
}
table tr {
    border: 1px solid #dfe2e5;
    margin: 0;
    padding: 0;
}
table tr:nth-child(2n),
thead {
    background-color: #f8f8f8;
}
table th {
    font-weight: bold;
    border: 1px solid #dfe2e5;
    border-bottom: 0;
    margin: 0;
    padding: 6px 13px;
}
table td {
    border: 1px solid #dfe2e5;
    margin: 0;
    padding: 6px 13px;
}
table th:first-child,
table td:first-child {
    margin-top: 0;
}
table th:last-child,
table td:last-child {
    margin-bottom: 0;
}

.CodeMirror-lines {
    padding-left: 4px;
}

.code-tooltip {
    box-shadow: 0 1px 1px 0 rgba(0,28,36,.3);
    border-top: 1px solid #eef2f2;
}

.md-fences,
code,
tt {
    border: 1px solid #e7eaed;
    background-color: #f8f8f8;
    border-radius: 3px;
    padding: 0;
    padding: 2px 4px 0px 4px;
    font-size: 0.9em;
}

code {
    background-color: #f3f4f4;
    padding: 0 2px 0 2px;
}

.md-fences {
    margin-bottom: 15px;
    margin-top: 15px;
    padding-top: 8px;
    padding-bottom: 6px;
}


.md-task-list-item > input {
  margin-left: -1.3em;
}

@media print {
    html {
        font-size: 13px;
    }
    pre {
        page-break-inside: avoid;
        word-wrap: break-word;
    }
}

.md-fences {
	background-color: #f8f8f8;
}
#write pre.md-meta-block {
	padding: 1rem;
    font-size: 85%;
    line-height: 1.45;
    background-color: #f7f7f7;
    border: 0;
    border-radius: 3px;
    color: #777777;
    margin-top: 0 !important;
}

.mathjax-block>.code-tooltip {
	bottom: .375rem;
}

.md-mathjax-midline {
    background: #fafafa;
}

#write>h3.md-focus:before{
	left: -1.5625rem;
	top: .375rem;
}
#write>h4.md-focus:before{
	left: -1.5625rem;
	top: .285714286rem;
}
#write>h5.md-focus:before{
	left: -1.5625rem;
	top: .285714286rem;
}
#write>h6.md-focus:before{
	left: -1.5625rem;
	top: .285714286rem;
}
.md-image>.md-meta {
    /*border: 1px solid #ddd;*/
    border-radius: 3px;
    padding: 2px 0px 0px 4px;
    font-size: 0.9em;
    color: inherit;
}

.md-tag {
    color: #a7a7a7;
    opacity: 1;
}

.md-toc { 
    margin-top:20px;
    padding-bottom:20px;
}

.sidebar-tabs {
    border-bottom: none;
}

#typora-quick-open {
    border: 1px solid #ddd;
    background-color: #f8f8f8;
}

#typora-quick-open-item {
    background-color: #FAFAFA;
    border-color: #FEFEFE #e5e5e5 #e5e5e5 #eee;
    border-style: solid;
    border-width: 1px;
}

/** focus mode */
.on-focus-mode blockquote {
    border-left-color: rgba(85, 85, 85, 0.12);
}

header, .context-menu, .megamenu-content, footer{
    font-family: "Segoe UI", "Arial", sans-serif;
}

.file-node-content:hover .file-node-icon,
.file-node-content:hover .file-node-open-state{
    visibility: visible;
}

.mac-seamless-mode #typora-sidebar {
    background-color: #fafafa;
    background-color: var(--side-bar-bg-color);
}

.mac-os #write{
    caret-color: AccentColor;
}

.md-lang {
    color: #b4654d;
}

/*.html-for-mac {
    --item-hover-bg-color: #E6F0FE;
}*/

#md-notification .btn {
    border: 0;
}

.dropdown-menu .divider {
    border-color: #e5e5e5;
    opacity: 0.4;
}

.ty-preferences .window-content {
    background-color: #fafafa;
}

.ty-preferences .nav-group-item.active {
    color: white;
    background: #999;
}

.menu-item-container a.menu-style-btn {
    background-color: #f5f8fa;
    background-image: linear-gradient( 180deg , hsla(0, 0%, 100%, 0.8), hsla(0, 0%, 100%, 0)); 
}
</style>
<style type='text/css'  id="style-lp">ol, ul {padding-left: 40px}</style>

<title></title>
</head>
<body class='typora-export os-windows'><div class='typora-export-content'>
<div id='write'  class=''><!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>S-Engine Magic Combat Simulator v8.4</title>
  <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+KR:wght@400;500;700&family=Noto+Serif+KR:wght@600;700&display=swap" rel="stylesheet">
  <style>
    * { box-sizing: border-box; margin: 0; padding: 0; }
    body {
      min-height: 100vh;
      background: linear-gradient(180deg, #0a0a0f 0%, #1a1a2e 50%, #0a0a0f 100%);
      color: #e0e0e0;
      font-family: 'Noto Sans KR', -apple-system, sans-serif;
      padding: 10px 8px;
      font-size: 12px;
    }
    .container { max-width: 1700px; margin: 0 auto; }
    header { text-align: center; margin-bottom: 10px; }
    h1 {
      font-family: 'Noto Serif KR', serif;
      font-size: 1.5rem;
      background: linear-gradient(135deg, #ffd700 0%, #ff6b35 50%, #ffd700 100%);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      background-clip: text;
    }
    .subtitle { color: #888; font-size: 0.7rem; }
    .main-layout {
      display: grid;
      grid-template-columns: 1fr 380px 1fr;
      gap: 10px;
      align-items: start;
    }
    @media (max-width: 1500px) {
      .main-layout { grid-template-columns: 1fr; }
      .team { flex-direction: row !important; flex-wrap: wrap; justify-content: center; }
      .char-card { width: 280px; }
    }
    .team { display: flex; flex-direction: column; gap: 8px; }
    .team-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 6px 10px;
      border-radius: 6px;
    }
    .team-header.ally { background: rgba(231,76,60,0.12); border: 1px solid rgba(231,76,60,0.25); }
    .team-header.enemy { background: rgba(52,152,219,0.12); border: 1px solid rgba(52,152,219,0.25); }
    .team-header h2 { font-family: 'Noto Serif KR', serif; font-size: 0.95rem; }
    .team-header.ally h2 { color: #e74c3c; }
    .team-header.enemy h2 { color: #3498db; }
    .btn-add {
      padding: 3px 10px;
      font-size: 0.7rem;
      background: rgba(255,255,255,0.08);
      border: 1px solid rgba(255,255,255,0.15);
      border-radius: 4px;
      color: #aaa;
      cursor: pointer;
    }
    .btn-add:hover { background: rgba(255,255,255,0.15); }
    .btn-add:disabled { opacity: 0.3; cursor: not-allowed; }
    .char-card {
      background: rgba(0,0,0,0.25);
      border-radius: 8px;
      padding: 8px;
      position: relative;
      border: 1px solid rgba(255,255,255,0.08);
    }
    .char-card.ally { border-left: 3px solid rgba(231,76,60,0.5); }
    .char-card.enemy { border-left: 3px solid rgba(52,152,219,0.5); }
    .char-card.dead { opacity: 0.35; filter: grayscale(0.7); }
    .char-card.active { box-shadow: 0 0 12px rgba(255,215,0,0.4); }
    .btn-remove {
      position: absolute;
      top: 4px;
      right: 4px;
      width: 16px;
      height: 16px;
      padding: 0;
      font-size: 11px;
      line-height: 14px;
      background: rgba(255,0,0,0.15);
      border: 1px solid rgba(255,0,0,0.25);
      border-radius: 50%;
      color: #e74c3c;
      cursor: pointer;
    }
    .char-header {
      display: flex;
      align-items: center;
      gap: 6px;
      margin-bottom: 6px;
    }
    .char-header input {
      flex: 1;
      padding: 3px 6px;
      background: rgba(0,0,0,0.3);
      border: 1px solid rgba(255,255,255,0.1);
      border-radius: 3px;
      color: #fff;
      font-size: 0.75rem;
      font-weight: bold;
    }
    .char-status {
      font-size: 0.6rem;
      padding: 2px 5px;
      border-radius: 3px;
    }
    .char-status.alive { background: rgba(46,204,113,0.2); color: #2ecc71; }
    .char-status.dead { background: rgba(231,76,60,0.2); color: #e74c3c; }
    .config-row {
      display: grid;
      grid-template-columns: repeat(4, 1fr);
      gap: 4px;
      margin-bottom: 5px;
    }
    .config-row.three-col { grid-template-columns: repeat(3, 1fr); }
    .config-item label {
      display: block;
      font-size: 0.55rem;
      color: #777;
      margin-bottom: 1px;
    }
    .config-item select {
      width: 100%;
      padding: 2px 3px;
      background: rgba(0,0,0,0.35);
      border: 1px solid rgba(255,255,255,0.1);
      border-radius: 2px;
      color: #fff;
      font-size: 0.65rem;
    }
    .ungi-row {
      display: flex;
      align-items: center;
      gap: 6px;
      margin-bottom: 5px;
    }
    .ungi-label { font-size: 0.65rem; color: #ffd700; min-width: 22px; }
    .ungi-bar-wrap {
      flex: 1;
      position: relative;
      height: 12px;
      background: rgba(0,0,0,0.4);
      border-radius: 6px;
      overflow: hidden;
    }
    .ungi-bar {
      height: 100%;
      border-radius: 6px;
      transition: width 0.05s linear;
    }
    .ungi-bar.ally { background: linear-gradient(90deg, #c0392b, #e74c3c, #f39c12); }
    .ungi-bar.enemy { background: linear-gradient(90deg, #2980b9, #3498db, #1abc9c); }
    .ungi-bar.ready { box-shadow: 0 0 8px rgba(46,204,113,0.7); }
    .ungi-threshold {
      position: absolute;
      left: 80%;
      top: 0;
      bottom: 0;
      width: 1px;
      background: #2ecc71;
    }
    .ungi-value {
      font-size: 0.65rem;
      font-weight: bold;
      min-width: 32px;
      text-align: right;
    }
    .ungi-value.ready { color: #2ecc71; }
    .ungi-value.charging { color: #f39c12; }
    .stat-row {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 4px;
      margin-bottom: 5px;
    }
    .stat-item {
      background: rgba(0,0,0,0.2);
      border-radius: 3px;
      padding: 3px 5px;
    }
    .stat-item .label {
      display: flex;
      justify-content: space-between;
      font-size: 0.55rem;
      margin-bottom: 2px;
    }
    .stat-item .track {
      height: 4px;
      background: rgba(255,255,255,0.1);
      border-radius: 2px;
      overflow: hidden;
    }
    .stat-item .fill { height: 100%; }
    .stat-item .fill.hp { background: linear-gradient(90deg, #c0392b, #e74c3c); }
    .stat-item .fill.ng { background: linear-gradient(90deg, #2980b9, #3498db); }
    .potion-row {
      display: flex;
      gap: 8px;
      font-size: 0.6rem;
      margin-bottom: 4px;
    }
    .potion-item {
      display: flex;
      align-items: center;
      gap: 3px;
    }
    .potion-count {
      padding: 1px 4px;
      background: rgba(46,204,113,0.2);
      border-radius: 2px;
      color: #2ecc71;
      min-width: 14px;
      text-align: center;
    }
    .potion-count.empty { background: rgba(231,76,60,0.2); color: #e74c3c; }
    .potion-input {
      width: 30px;
      padding: 1px 2px;
      background: rgba(0,0,0,0.3);
      border: 1px solid rgba(255,255,255,0.1);
      border-radius: 2px;
      color: #fff;
      font-size: 0.6rem;
    }
    .action-row {
      padding: 4px;
      background: rgba(155,89,182,0.1);
      border-radius: 3px;
      font-size: 0.6rem;
      text-align: center;
      min-height: 18px;
    }
    .action-row.attack { color: #e74c3c; font-weight: bold; }
    .action-row.defend { color: #3498db; }
    .action-row.move { color: #f39c12; }
    .action-row.potion { color: #2ecc71; }
    .battle-area { display: flex; flex-direction: column; gap: 8px; }
    .battle-controls {
      display: flex;
      gap: 6px;
      flex-wrap: wrap;
      justify-content: center;
    }
    .btn {
      padding: 8px 16px;
      font-size: 0.8rem;
      font-weight: bold;
      border: none;
      border-radius: 6px;
      cursor: pointer;
      transition: all 0.2s;
    }
    .btn:hover { transform: scale(1.03); }
    .btn:disabled { opacity: 0.5; cursor: not-allowed; transform: none; }
    .btn-start { background: linear-gradient(135deg, #2ecc71, #27ae60); color: #fff; }
    .btn-stop { background: linear-gradient(135deg, #e74c3c, #c0392b); color: #fff; }
    .btn-reset { background: rgba(255,255,255,0.1); border: 1px solid rgba(255,255,255,0.2); color: #aaa; }
    .options-row {
      display: flex;
      gap: 8px;
      justify-content: center;
      flex-wrap: wrap;
    }
    .settings-section {
      background: rgba(255,255,255,0.03);
      border: 1px solid rgba(255,255,255,0.08);
      border-radius: 6px;
      padding: 6px 10px;
      margin-bottom: 8px;
    }
    .section-label {
      font-size: 0.7rem;
      color: #ffd700;
      font-weight: bold;
      margin-bottom: 6px;
      padding-bottom: 4px;
      border-bottom: 1px solid rgba(255,215,0,0.2);
    }
    .option-box {
      display: flex;
      align-items: center;
      gap: 4px;
      padding: 4px 8px;
      background: rgba(255,255,255,0.05);
      border-radius: 4px;
      font-size: 0.65rem;
    }
    .option-box label { color: #888; }
    .option-box select {
      padding: 2px 4px;
      background: rgba(0,0,0,0.3);
      border: 1px solid rgba(255,255,255,0.12);
      border-radius: 3px;
      color: #fff;
      font-size: 0.65rem;
    }
    .battle-log-container {
      background: rgba(0,0,0,0.4);
      border: 1px solid rgba(255,255,255,0.1);
      border-radius: 8px;
      display: flex;
      flex-direction: column;
      height: 420px;
    }
    .log-header {
      padding: 6px 10px;
      border-bottom: 1px solid rgba(255,255,255,0.1);
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    .log-header h3 {
      color: #ffd700;
      font-family: 'Noto Serif KR', serif;
      font-size: 0.85rem;
    }
    .log-stats {
      display: flex;
      gap: 6px;
      font-size: 0.6rem;
    }
    .log-stats span { padding: 2px 5px; border-radius: 3px; }
    .log-stats .time { background: rgba(155,89,182,0.2); color: #9b59b6; }
    .log-stats .round { background: rgba(255,215,0,0.2); color: #ffd700; }
    .log-stats .potion { background: rgba(46,204,113,0.2); color: #2ecc71; }
    .log-content {
      flex: 1;
      overflow-y: auto;
      padding: 8px;
      font-family: 'D2Coding', monospace;
      font-size: 0.65rem;
      line-height: 1.4;
    }
    .log-line { margin-bottom: 1px; color: #bbb; }
    .log-line.move { color: #f39c12; }
    .log-line.stun { color: #e67e22; font-style: italic; }
    .log-line.attack { color: #e74c3c; font-weight: bold; }
    .log-line.defend { color: #3498db; }
    .log-line.damage { color: #ff6b6b; }
    .log-line.naesang { color: #9b59b6; font-style: italic; }
    .log-line.combo { color: #ffd700; }
    .log-line.ready { color: #2ecc71; font-weight: bold; }
    .log-line.info { color: #888; font-style: italic; }
    .log-line.potion { color: #2ecc71; }
    .log-line.critical { color: #e74c3c; font-weight: bold; background: rgba(231,76,60,0.1); padding: 1px 3px; border-radius: 2px; }
    .log-line.divider { color: #555; text-align: center; }
    .log-line.mugong { color: #9b59b6; font-weight: bold; }
    .battle-result {
      padding: 8px;
      border-top: 1px solid rgba(255,255,255,0.1);
      text-align: center;
    }
    .result-text {
      font-family: 'Noto Serif KR', serif;
      font-size: 1rem;
      color: #ffd700;
    }
    footer {
      text-align: center;
      margin-top: 10px;
      color: #555;
      font-size: 0.6rem;
    }
    .highlight-red { color: #e74c3c; }
    .highlight-blue { color: #3498db; }
    .highlight-gold { color: #ffd700; }
    .highlight-green { color: #2ecc71; }
  </style>
</head>
<body>
  <div class="container">
    <header>
      <h1>S-Engine Magic Combat Simulator</h1>
      <p class="subtitle">v8.4 - Complete Magic Edition</p>
    </header>
    
    <div class="main-layout">
      <div class="team" id="ally-team">
        <div class="team-header ally">
          <h2>‚öîÔ∏è Allies</h2>
          <button class="btn-add" id="ally-add-btn" onclick="addCharacter('ally')">+ Add</button>
        </div>
        <div id="ally-chars"></div>
      </div>
      
      <div class="battle-area">
        <div class="battle-controls">
          <button class="btn btn-start" id="btn-start" onclick="startBattle()">‚ñ∂Ô∏è Start Battle</button>
          <button class="btn btn-stop" id="btn-stop" onclick="stopBattle()" style="display:none;">‚è∏Ô∏è Stop</button>
          <button class="btn btn-reset" onclick="resetBattle()">‚Ü∫ Reset</button>
        </div>
        
        <div class="settings-section">
          <div class="section-label">‚öôÔ∏è Basic Settings</div>
          <div class="options-row">
            <div class="option-box">
              <label>‚è±Ô∏è Speed</label>
              <select id="sim-speed">
                <option value="1" selected>1x</option>
                <option value="2">2x</option>
                <option value="3">3x</option>
                <option value="5">5x</option>
                <option value="10">10x</option>
              </select>
            </div>
            <div class="option-box">
              <label>‚öîÔ∏è Mode</label>
              <select id="battle-mode">
                <option value="simultaneous">Simultaneous</option>
                <option value="sequential">Sequential</option>
              </select>
            </div>
            <div class="option-box">
              <label>üéØ Target</label>
              <select id="targeting-mode">
                <option value="weakest">Weakest</option>
                <option value="strongest">Strongest</option>
                <option value="random">Random</option>
              </select>
            </div>
            <div class="option-box">
              <label>‚öîÔ∏è Spell AI</label>
              <select id="mugong-response">
                <option value="max">Max</option>
                <option value="match" selected>Match</option>
                <option value="save">Save</option>
              </select>
            </div>
          </div>
        </div>
        
        <div class="settings-section">
          <div class="section-label">üíä Potions</div>
          <div class="options-row">
            <div class="option-box">
              <label>‚ù§Ô∏è HP Heal</label>
              <select id="potion-heal-hp">
                <option value="15" selected>15%</option>
                <option value="20">20%</option>
                <option value="25">25%</option>
              </select>
            </div>
            <div class="option-box">
              <label>üíô Mana Heal</label>
              <select id="potion-heal-ng">
                <option value="15" selected>15%</option>
                <option value="20">20%</option>
                <option value="25">25%</option>
              </select>
            </div>
            <div class="option-box">
              <label>‚ù§Ô∏è HP Auto</label>
              <select id="hp-threshold">
                <option value="70">70%</option>
                <option value="75" selected>75%</option>
                <option value="80">80%</option>
              </select>
            </div>
            <div class="option-box">
              <label>üíô Mana Auto</label>
              <select id="ng-threshold">
                <option value="70">70%</option>
                <option value="75" selected>75%</option>
                <option value="80">80%</option>
              </select>
            </div>
          </div>
        </div>
        
        <div class="settings-section">
          <div class="section-label">üíÄ KO & Penalties</div>
          <div class="options-row">
            <div class="option-box">
              <label>‚ù§Ô∏è HP KO</label>
              <select id="hp-dead-threshold">
                <option value="30" selected>30%</option>
                <option value="40">40%</option>
              </select>
            </div>
            <div class="option-box">
              <label>üíô Mana KO</label>
              <select id="ng-dead-threshold">
                <option value="30" selected>30%</option>
                <option value="40">40%</option>
              </select>
            </div>
            <div class="option-box">
              <label>üíô Miss Below</label>
              <select id="miss-ng-threshold">
                <option value="50" selected>50%</option>
                <option value="60">60%</option>
              </select>
            </div>
            <div class="option-box">
              <label>‚ù§Ô∏è Weak Below</label>
              <select id="hp-penalty-threshold">
                <option value="80" selected>80%</option>
                <option value="90">90%</option>
              </select>
            </div>
          </div>
        </div>
        
        <div class="settings-section">
          <div class="section-label">üìä Multipliers</div>
          <div class="options-row">
            <div class="option-box">
              <label>üíô Mana</label>
              <select id="mult-neigong">
                <option value="100" selected>100x</option>
                <option value="150">150x</option>
              </select>
            </div>
            <div class="option-box">
              <label>‚ù§Ô∏è HP</label>
              <select id="mult-hp">
                <option value="50" selected>50x</option>
                <option value="70">70x</option>
              </select>
            </div>
            <div class="option-box">
              <label>‚öîÔ∏è Cost</label>
              <select id="mult-skill">
                <option value="30" selected>30x</option>
                <option value="50">50x</option>
              </select>
            </div>
            <div class="option-box">
              <label>üí• Split</label>
              <select id="damage-split">
                <option value="90-10" selected>M90/H10</option>
                <option value="80-20">M80/H20</option>
                <option value="70-30">M70/H30</option>
              </select>
            </div>
          </div>
        </div>
        
        <div class="battle-log-container">
          <div class="log-header">
            <h3>üìú Battle Log</h3>
            <div class="log-stats">
              <span class="time">‚è±Ô∏è <span id="battle-time">0.0</span>s</span>
              <span class="round">üí• <span id="attack-count">0</span></span>
              <span class="potion">üíä <span id="potion-used">0</span></span>
            </div>
          </div>
          <div class="log-content" id="log-content">
            <div class="log-line info">Place characters and start battle.</div>
            <div class="log-line info">Up to 5 vs 5 supported.</div>
          </div>
          <div class="battle-result" id="battle-result" style="display: none;">
            <div class="result-text" id="result-text"></div>
          </div>
        </div>
      </div>
      
      <div class="team" id="enemy-team">
        <div class="team-header enemy">
          <h2>üõ°Ô∏è Enemies</h2>
          <button class="btn-add" id="enemy-add-btn" onclick="addCharacter('enemy')">+ Add</button>
        </div>
        <div id="enemy-chars"></div>
      </div>
    </div>
    
    <footer>
      S-Engine Magic Combat Simulator v8.4 by ShadowK
    </footer>
  </div>
  
  <script>
    const GYEONGJI = {
      '1-Circle': { level: 1, speed: Math.sqrt(1), neigong: 5 },
      '2-Circle': { level: 2, speed: Math.sqrt(2), neigong: 10 },
      '3-Circle': { level: 3, speed: Math.sqrt(3), neigong: 30 },
      '4-Circle': { level: 4, speed: Math.sqrt(4), neigong: 60 },
      '5-Circle': { level: 5, speed: Math.sqrt(5), neigong: 120 },
      '6-Circle': { level: 6, speed: Math.sqrt(6), neigong: 180 },
      '7-Circle': { level: 7, speed: Math.sqrt(7), neigong: 240 },
      '8-Circle': { level: 8, speed: Math.sqrt(8), neigong: 300 },
      '9-Circle': { level: 9, speed: Math.sqrt(9), neigong: 360 }
    };
    
    const SIMBEOP = {
      'Basic Meditation': { chukgi: 10, stab: 90, type: 'Basic', tier: 0 },
      'Apprentice Meditation': { chukgi: 20, stab: 80, type: 'Apprentice', tier: 1 },
      'Adept Meditation': { chukgi: 30, stab: 70, type: 'Adept', tier: 2 },
      'Expert Meditation': { chukgi: 40, stab: 70, type: 'Expert', tier: 3 },
      'Master Meditation': { chukgi: 70, stab: 60, type: 'Master', tier: 4 },
      'Arcane Focus': { chukgi: 110, stab: 80, type: 'Archmage Lv1', tier: 5 },
      'Celestial Trance': { chukgi: 130, stab: 70, type: 'Archmage Lv2', tier: 5 },
      'Void Meditation': { chukgi: 120, stab: 80, type: 'Archmage Lv2', tier: 5 }
    };
    
    const THRESHOLD = { 'Basic': 50, 'Apprentice': 50, 'Adept': 45, 'Expert': 40, 'Master': 35, 'Archmage Lv1': 30, 'Archmage Lv2': 25 };
    
    const MUGONG = {
      'Spark': { 1: [2,1], 2: [4,1], 3: [6,1], 4: [8,1], 5: [10,1] },
      'Bolt': { 1: [6,2], 2: [9,2], 3: [12,2], 4: [15,2], 5: [18,2] },
      'Blast': { 1: [15,3], 2: [19,3], 3: [23,3], 4: [28,3], 5: [33,3] }
    };
    
    const BALCHUL = {
      'None': { bonus: 0, cost: 0 },
      'Quick Cast': { bonus: 8, cost: 2 },
      'Instant Cast': { bonus: 12, cost: 3 },
      'Power Cast': { bonus: 18, cost: 4 },
      'Ultimate Cast': { bonus: 25, cost: 5 }
    };
    
    const MUGONG_LIMIT = {
      '1-Circle':   { Spark: 1, Bolt: 0, Blast: 0 },
      '2-Circle':   { Spark: 2, Bolt: 1, Blast: 0 },
      '3-Circle':   { Spark: 3, Bolt: 2, Blast: 0 },
      '4-Circle':   { Spark: 4, Bolt: 3, Blast: 1 },
      '5-Circle':   { Spark: 5, Bolt: 4, Blast: 2 },
      '6-Circle':   { Spark: 5, Bolt: 5, Blast: 3 },
      '7-Circle':   { Spark: 5, Bolt: 5, Blast: 4 },
      '8-Circle':   { Spark: 5, Bolt: 5, Blast: 5 },
      '9-Circle':   { Spark: 5, Bolt: 5, Blast: 5 }
    };
    
    const BALCHUL_LIMIT = {
      '1-Circle':   { 'None': true, 'Quick Cast': false, 'Instant Cast': false, 'Power Cast': false, 'Ultimate Cast': false },
      '2-Circle':   { 'None': true, 'Quick Cast': false, 'Instant Cast': false, 'Power Cast': false, 'Ultimate Cast': false },
      '3-Circle':   { 'None': true, 'Quick Cast': 1, 'Instant Cast': false, 'Power Cast': false, 'Ultimate Cast': false },
      '4-Circle':   { 'None': true, 'Quick Cast': 2, 'Instant Cast': 1, 'Power Cast': false, 'Ultimate Cast': false },
      '5-Circle':   { 'None': true, 'Quick Cast': 3, 'Instant Cast': 3, 'Power Cast': 1, 'Ultimate Cast': false },
      '6-Circle':   { 'None': true, 'Quick Cast': 5, 'Instant Cast': 4, 'Power Cast': 2, 'Ultimate Cast': 1 },
      '7-Circle':   { 'None': true, 'Quick Cast': 5, 'Instant Cast': 5, 'Power Cast': 3, 'Ultimate Cast': 2 },
      '8-Circle':   { 'None': true, 'Quick Cast': 5, 'Instant Cast': 5, 'Power Cast': 4, 'Ultimate Cast': 4 },
      '9-Circle':   { 'None': true, 'Quick Cast': 5, 'Instant Cast': 5, 'Power Cast': 5, 'Ultimate Cast': 5 }
    };
    
    const SIMBEOP_LIMIT = {
      '1-Circle':   ['Basic Meditation', 'Apprentice Meditation'],
      '2-Circle':   ['Basic Meditation', 'Apprentice Meditation', 'Adept Meditation'],
      '3-Circle':   ['Basic Meditation', 'Apprentice Meditation', 'Adept Meditation', 'Expert Meditation'],
      '4-Circle':   ['Basic Meditation', 'Apprentice Meditation', 'Adept Meditation', 'Expert Meditation'],
      '5-Circle':   ['Basic Meditation', 'Apprentice Meditation', 'Adept Meditation', 'Expert Meditation', 'Master Meditation'],
      '6-Circle':   ['Basic Meditation', 'Apprentice Meditation', 'Adept Meditation', 'Expert Meditation', 'Master Meditation', 'Arcane Focus', 'Celestial Trance', 'Void Meditation'],
      '7-Circle':   ['Basic Meditation', 'Apprentice Meditation', 'Adept Meditation', 'Expert Meditation', 'Master Meditation', 'Arcane Focus', 'Celestial Trance', 'Void Meditation'],
      '8-Circle':   ['Basic Meditation', 'Apprentice Meditation', 'Adept Meditation', 'Expert Meditation', 'Master Meditation', 'Arcane Focus', 'Celestial Trance', 'Void Meditation'],
      '9-Circle':   ['Basic Meditation', 'Apprentice Meditation', 'Adept Meditation', 'Expert Meditation', 'Master Meditation', 'Arcane Focus', 'Celestial Trance', 'Void Meditation']
    };
    
    const BOBEOP_LIMIT = {
      '1-Circle': 2, '2-Circle': 3, '3-Circle': 4, '4-Circle': 5, '5-Circle': 6,
      '6-Circle': 7, '7-Circle': 8, '8-Circle': 9, '9-Circle': 10
    };
    
    const DEFAULT_SIMBEOP = {
      '1-Circle': 'Apprentice Meditation', '2-Circle': 'Adept Meditation', '3-Circle': 'Expert Meditation', '4-Circle': 'Expert Meditation',
      '5-Circle': 'Master Meditation', '6-Circle': 'Master Meditation', '7-Circle': 'Arcane Focus', '8-Circle': 'Celestial Trance', '9-Circle': 'Celestial Trance'
    };
    
    const LEVEL_NAME = ['', 'Novice', 'Skilled', 'Expert', 'Master', 'Grand'];
    const DIRECTIONS = ['Forward', 'Fwd-Left', 'Fwd-Right', 'Left', 'Right', 'Retreat', 'Back-Left', 'Back-Right'];
    const APPROACH_DIR = ['Forward', 'Fwd-Left', 'Fwd-Right'];
    const RETREAT_DIR = ['Retreat', 'Back-Left', 'Back-Right'];
    
    const ATTACK_TYPES = {
      Spark: ['Direct Spark', 'Spark Slash', 'Spark Pierce'],
      Bolt: ['Lightning Flash', 'Bolt Spin', 'Bolt Barrage'],
      Blast: ['Blast Wave', 'Focused Blast', 'Void Blast']
    };
    
    const BALCHUL_DESC = {
      'Quick Cast': 'Magic tears the air!',
      'Instant Cast': 'Lightning incantation!',
      'Power Cast': 'Overwhelming force!',
      'Ultimate Cast': 'Reality bends!'
    };
    
    const DEFEND_TYPES = ['Barrier deflect', 'Dodge twist', 'Shield retreat', 'Counter-spell'];
    const COMBO_BONUS = { 2: 0.05, 3: 0.10, 4: 0.15 };

let state = {
      running: false,
      time: 0,
      attackCount: 0,
      winner: null,
      animFrame: null,
      lastTime: 0,
      totalPotionsUsed: 0,
      hpPotionsUsed: 0,
      ngPotionsUsed: 0,
      chars: { ally: [], enemy: [] }
    };
    
    let charIdCounter = 0;
    
    function adjustMugongForGyeongji(char) {
      const mugongLimit = MUGONG_LIMIT[char.gyeongji];
      const balchulLimit = BALCHUL_LIMIT[char.gyeongji];
      
      if (mugongLimit['Blast'] > 0) { char.mugong = 'Blast'; char.mugongLv = mugongLimit['Blast']; }
      else if (mugongLimit['Bolt'] > 0) { char.mugong = 'Bolt'; char.mugongLv = mugongLimit['Bolt']; }
      else { char.mugong = 'Spark'; char.mugongLv = mugongLimit['Spark']; }
      
      if (balchulLimit['Ultimate Cast']) { char.balchul = 'Ultimate Cast'; char.balchulLv = balchulLimit['Ultimate Cast']; }
      else if (balchulLimit['Power Cast']) { char.balchul = 'Power Cast'; char.balchulLv = balchulLimit['Power Cast']; }
      else if (balchulLimit['Instant Cast']) { char.balchul = 'Instant Cast'; char.balchulLv = balchulLimit['Instant Cast']; }
      else if (balchulLimit['Quick Cast']) { char.balchul = 'Quick Cast'; char.balchulLv = balchulLimit['Quick Cast']; }
      else { char.balchul = 'None'; char.balchulLv = 1; }
      
      char.simbeop = DEFAULT_SIMBEOP[char.gyeongji];
      char.bobeop = BOBEOP_LIMIT[char.gyeongji];
    }
    
    function createCharacter(team, preset = {}) {
      const id = ++charIdCounter;
      const isAlly = team === 'ally';
      const gyeongji = preset.gyeongji || (isAlly ? '4-Circle' : '3-Circle');
      
      const mugongLimit = MUGONG_LIMIT[gyeongji];
      let defaultMugong = 'Spark';
      let defaultMugongLv = mugongLimit['Spark'];
      if (mugongLimit['Blast'] > 0) { defaultMugong = 'Blast'; defaultMugongLv = mugongLimit['Blast']; }
      else if (mugongLimit['Bolt'] > 0) { defaultMugong = 'Bolt'; defaultMugongLv = mugongLimit['Bolt']; }
      
      const balchulLimit = BALCHUL_LIMIT[gyeongji];
      let defaultBalchul = 'None';
      let defaultBalchulLv = 0;
      if (balchulLimit['Ultimate Cast']) { defaultBalchul = 'Ultimate Cast'; defaultBalchulLv = balchulLimit['Ultimate Cast']; }
      else if (balchulLimit['Power Cast']) { defaultBalchul = 'Power Cast'; defaultBalchulLv = balchulLimit['Power Cast']; }
      else if (balchulLimit['Instant Cast']) { defaultBalchul = 'Instant Cast'; defaultBalchulLv = balchulLimit['Instant Cast']; }
      else if (balchulLimit['Quick Cast']) { defaultBalchul = 'Quick Cast'; defaultBalchulLv = balchulLimit['Quick Cast']; }
      
      const defaultSimbeop = DEFAULT_SIMBEOP[gyeongji];
      const defaultBobeop = BOBEOP_LIMIT[gyeongji];
      
      return {
        id, team,
        name: preset.name || (isAlly ? `Ally${id}` : `Enemy${id}`),
        gyeongji: gyeongji,
        simbeop: preset.simbeop || defaultSimbeop,
        bobeop: preset.bobeop ?? defaultBobeop,
        mugong: preset.mugong || defaultMugong,
        mugongLv: preset.mugongLv || defaultMugongLv,
        balchul: preset.balchul || defaultBalchul,
        balchulLv: preset.balchulLv || defaultBalchulLv || 1,
        hp: 100, neigong: 100, ungi: 0,
        cooldown: 0,
        hpPotions: preset.hpPotions ?? (isAlly ? 5 : 3),
        ngPotions: preset.ngPotions ?? (isAlly ? 5 : 3),
        hpThreshold: 50, ngThreshold: 60,
        currentAction: 'Waiting',
        comboCount: 0, lastTarget: null
      };
    }
    
    function addCharacter(team) {
      if (state.chars[team].length >= 5 || state.running) return;
      state.chars[team].push(createCharacter(team));
      renderTeam(team);
      updateAddButtons();
    }
    
    function removeCharacter(team, id) {
      if (state.running) return;
      state.chars[team] = state.chars[team].filter(c => c.id !== id);
      renderTeam(team);
      updateAddButtons();
    }
    
    function updateAddButtons() {
      ['ally', 'enemy'].forEach(team => {
        const btn = document.getElementById(`${team}-add-btn`);
        btn.disabled = state.chars[team].length >= 5 || state.running;
      });
    }
    
    function calcChar(char) {
      const g = GYEONGJI[char.gyeongji];
      const s = SIMBEOP[char.simbeop];
      const m = MUGONG[char.mugong]?.[char.mugongLv] || [0, 0];
      const b = BALCHUL[char.balchul] || { bonus: 0, cost: 0 };
      
      const atkTime = 3 / g.speed;
      const ungiPath = Math.sqrt(s.chukgi);
      const danger = 1 / Math.sqrt(s.stab);
      
      const speedPenalty = char.speedPenalty || 0;
      const ungiPerSec = (100 / atkTime) * (1 + speedPenalty);
      
      const power = Math.sqrt(g.neigong) * ungiPath * (char.ungi / 100);
      
      const bobeopBonus = char.bobeop * 0.1;
      const moveSpeed = char.bobeop > 0 ? Math.sqrt(char.bobeop) : 1;
      const mugongBonus = m[0] / 100;
      const mugongCost = m[1];
      const balchulBonus = (b.bonus * char.balchulLv / 5) / 100;
      const balchulCost = b.cost;
      
      const threshold = THRESHOLD[s.type];
      const hpDeadThreshold = parseInt(document.getElementById('hp-dead-threshold')?.value || 30);
      const ngDeadThreshold = parseInt(document.getElementById('ng-dead-threshold')?.value || 30);
      const isDead = char.neigong <= ngDeadThreshold || char.hp <= hpDeadThreshold;
      
      return {
        g, s, atkTime, ungiPath, danger, ungiPerSec, power,
        bobeopBonus, moveSpeed, mugongBonus, mugongCost, balchulBonus, balchulCost,
        threshold, isDead
      };
    }
    
    function randomPick(arr) { return arr[Math.floor(Math.random() * arr.length)]; }
    
    function getMultipliers() {
      return {
        neigong: parseInt(document.getElementById('mult-neigong').value),
        hp: parseInt(document.getElementById('mult-hp').value),
        skill: parseInt(document.getElementById('mult-skill').value)
      };
    }
    
    function getDamageSplit() {
      const split = document.getElementById('damage-split').value.split('-');
      return {
        ng: parseInt(split[0]) / 100,
        hp: parseInt(split[1]) / 100
      };
    }
    
    function selectMugong(attacker, defender) {
      const mode = document.getElementById('mugong-response').value;
      const atkGyeongji = GYEONGJI[attacker.gyeongji].level;
      const defGyeongji = GYEONGJI[defender.gyeongji].level;
      
      let mugong = attacker.mugong;
      let mugongLv = attacker.mugongLv;
      let balchul = attacker.balchul;
      let balchulLv = attacker.balchulLv;
      
      if (mode === 'max') {
      } else if (mode === 'match') {
        const levelDiff = atkGyeongji - defGyeongji;
        
        if (levelDiff >= 3) {
          mugongLv = 1;
          balchul = 'None';
        } else if (levelDiff >= 2) {
          mugongLv = Math.min(2, attacker.mugongLv);
          balchul = 'None';
        } else if (levelDiff >= 1) {
          mugongLv = Math.min(3, attacker.mugongLv);
          balchul = 'None';
        } else {
          mugongLv = Math.min(attacker.mugongLv, defender.mugongLv + 1);
          if (defender.balchul !== 'None') {
            balchul = attacker.balchul;
          } else {
            balchul = Math.random() > 0.7 ? attacker.balchul : 'None';
          }
        }
      } else if (mode === 'save') {
        mugongLv = 1;
        balchul = 'None';
      }
      
      const m = MUGONG[mugong]?.[mugongLv] || [0, 0];
      const b = BALCHUL[balchul] || { bonus: 0, cost: 0 };
      
      return {
        mugong, mugongLv, balchul, balchulLv,
        mugongBonus: m[0] / 100,
        mugongCost: m[1],
        balchulBonus: (b.bonus * balchulLv / 5) / 100,
        balchulCost: b.cost
      };
    }
    
    function updateCharField(team, id, field, value) {
      const char = state.chars[team].find(c => c.id === id);
      if (char) {
        char[field] = value;
        
        if (field === 'gyeongji') {
          adjustMugongForGyeongji(char);
        }
        if (field === 'mugong') {
          const maxLv = MUGONG_LIMIT[char.gyeongji][char.mugong];
          if (char.mugongLv > maxLv) char.mugongLv = maxLv;
          if (char.mugongLv < 1) char.mugongLv = 1;
        }
        if (field === 'balchul') {
          const limit = BALCHUL_LIMIT[char.gyeongji];
          if (limit[char.balchul] !== true && limit[char.balchul] > 0) {
            if (char.balchulLv > limit[char.balchul]) char.balchulLv = limit[char.balchul];
            if (char.balchulLv < 1) char.balchulLv = 1;
          }
        }
        
        renderTeam(team);
      }
    }
      
function renderTeam(team) {
      const container = document.getElementById(`${team}-chars`);
      const inBattle = state.running;
      
      container.innerHTML = state.chars[team].map(char => {
        const c = calcChar(char);
        const statusClass = c.isDead ? 'dead' : 'alive';
        const statusText = c.isDead ? 'KO' : 'Active';
        const cardClass = c.isDead ? 'dead' : '';
        const ungiClass = char.ungi >= 80 ? 'ready' : 'charging';
        
        return `
          <div class="char-card ${team} ${cardClass}" data-id="${char.id}">
            ${!inBattle ? `<button class="btn-remove" onclick="removeCharacter('${team}', ${char.id})">√ó</button>` : ''}
            
            <div class="char-header">
              <input type="text" value="${char.name}" onchange="updateCharField('${team}', ${char.id}, 'name', this.value)" ${inBattle ? 'disabled' : ''}>
              <span class="char-status ${statusClass}">${statusText}</span>
            </div>
            
            <div class="config-row">
              <div class="config-item">
                <label>Circle</label>
                <select onchange="updateCharField('${team}', ${char.id}, 'gyeongji', this.value)" ${inBattle ? 'disabled' : ''}>
                  ${Object.keys(GYEONGJI).map(g => `<option value="${g}" ${char.gyeongji === g ? 'selected' : ''}>${g}</option>`).join('')}
                </select>
              </div>
              <div class="config-item">
                <label>Meditation</label>
                <select onchange="updateCharField('${team}', ${char.id}, 'simbeop', this.value)" ${inBattle ? 'disabled' : ''}>
                  ${SIMBEOP_LIMIT[char.gyeongji].map(s => `<option value="${s}" ${char.simbeop === s ? 'selected' : ''}>${s.replace(' Meditation','').replace(' Focus','').replace(' Trance','')}</option>`).join('')}
                </select>
              </div>
              <div class="config-item">
                <label>Shield</label>
                <select onchange="updateCharField('${team}', ${char.id}, 'bobeop', +this.value)" ${inBattle ? 'disabled' : ''}>
                  ${Array.from({length: BOBEOP_LIMIT[char.gyeongji] + 1}, (_, b) => `<option value="${b}" ${char.bobeop === b ? 'selected' : ''}>${b===0?'None':'Lv'+b}</option>`).join('')}
                </select>
              </div>
              <div class="config-item">
                <label>Spell</label>
                <select onchange="updateCharField('${team}', ${char.id}, 'mugong', this.value)" ${inBattle ? 'disabled' : ''}>
                  ${(() => {
                    const limit = MUGONG_LIMIT[char.gyeongji];
                    return Object.keys(MUGONG).filter(m => limit[m] > 0).map(m => 
                      `<option value="${m}" ${char.mugong === m ? 'selected' : ''}>${m}</option>`
                    ).join('');
                  })()}
                </select>
              </div>
            </div>
            
            <div class="config-row">
              <div class="config-item">
                <label>Mastery</label>
                <select onchange="updateCharField('${team}', ${char.id}, 'mugongLv', +this.value)" ${inBattle ? 'disabled' : ''}>
                  ${(() => {
                    const maxLv = MUGONG_LIMIT[char.gyeongji][char.mugong];
                    return [1,2,3,4,5].filter(l => l <= maxLv).map(l => 
                      `<option value="${l}" ${char.mugongLv === l ? 'selected' : ''}>${LEVEL_NAME[l]}</option>`
                    ).join('');
                  })()}
                </select>
              </div>
              <div class="config-item">
                <label>Casting</label>
                <select onchange="updateCharField('${team}', ${char.id}, 'balchul', this.value)" ${inBattle ? 'disabled' : ''}>
                  ${(() => {
                    const limit = BALCHUL_LIMIT[char.gyeongji];
                    return Object.keys(BALCHUL).filter(b => limit[b] !== false).map(b => 
                      `<option value="${b}" ${char.balchul === b ? 'selected' : ''}>${b}</option>`
                    ).join('');
                  })()}
                </select>
              </div>
              <div class="config-item">
                <label>Cast Skill</label>
                <select onchange="updateCharField('${team}', ${char.id}, 'balchulLv', +this.value)" ${inBattle ? 'disabled' : ''}>
                  ${(() => {
                    const limit = BALCHUL_LIMIT[char.gyeongji];
                    const maxLv = limit[char.balchul];
                    if (maxLv === true || maxLv === 0 || char.balchul === 'None') {
                      return '<option value="1">-</option>';
                    }
                    return [1,2,3,4,5].filter(l => l <= maxLv).map(l => 
                      `<option value="${l}" ${char.balchulLv === l ? 'selected' : ''}>${LEVEL_NAME[l]}</option>`
                    ).join('');
                  })()}
                </select>
              </div>
              <div class="config-item">
                <label>Power</label>
                <div style="font-size:0.7rem;color:#ffd700;padding-top:2px;">${c.power.toFixed(1)}</div>
              </div>
            </div>
            
            <div class="ungi-row">
              <span class="ungi-label">üåÄ</span>
              <div class="ungi-bar-wrap">
                <div class="ungi-threshold"></div>
                <div class="ungi-bar ${team} ${ungiClass}" style="width: ${Math.min(100, char.ungi)}%"></div>
              </div>
              <span class="ungi-value ${ungiClass}">${char.ungi.toFixed(0)}%</span>
            </div>
            
            <div class="stat-row">
              <div class="stat-item">
                <div class="label"><span>HP</span><span class="highlight-red">${char.hp.toFixed(1)}</span></div>
                <div class="track"><div class="fill hp" style="width:${Math.max(0,char.hp)}%"></div></div>
              </div>
              <div class="stat-item">
                <div class="label"><span>Mana</span><span class="highlight-blue">${char.neigong.toFixed(1)}</span></div>
                <div class="track"><div class="fill ng" style="width:${Math.max(0,char.neigong)}%"></div></div>
              </div>
            </div>
            
            <div class="potion-row">
              <div class="potion-item">
                ‚ù§Ô∏è<span class="potion-count ${char.hpPotions===0?'empty':''}">${char.hpPotions}</span>
                ${!inBattle ? `<input type="number" class="potion-input" value="${char.hpPotions}" min="0" max="99" onchange="updateCharField('${team}', ${char.id}, 'hpPotions', +this.value)">` : ''}
              </div>
              <div class="potion-item">
                üíô<span class="potion-count ${char.ngPotions===0?'empty':''}">${char.ngPotions}</span>
                ${!inBattle ? `<input type="number" class="potion-input" value="${char.ngPotions}" min="0" max="99" onchange="updateCharField('${team}', ${char.id}, 'ngPotions', +this.value)">` : ''}
              </div>
            </div>
            
            <div class="action-row ${getActionClass(char.currentAction)}">${char.currentAction}</div>
          </div>
        `;
      }).join('');
    }
    
    function getActionClass(action) {
      if (action.includes('Potion')) return 'potion';
      if (action.includes('Spark') || action.includes('Bolt') || action.includes('Blast') || action.includes('Cast')) return 'attack';
      if (action.includes('deflect') || action.includes('Dodge') || action.includes('Block')) return 'defend';
      return 'move';
    }
    
    function renderAll() {
      renderTeam('ally');
      renderTeam('enemy');
      document.getElementById('battle-time').textContent = state.time.toFixed(1);
      document.getElementById('attack-count').textContent = state.attackCount;
      document.getElementById('potion-used').textContent = state.totalPotionsUsed;
    }
    
    function addLog(text, cls = '') {
      const el = document.getElementById('log-content');
      const line = document.createElement('div');
      line.className = `log-line ${cls}`;
      line.textContent = text;
      el.appendChild(line);
      el.scrollTop = el.scrollHeight;
    }
    
    function addLogTime(text, cls = '') {
      addLog(`[${state.time.toFixed(2)}s] ${text}`, cls);
    }
    
    function getAliveChars(team) {
      return state.chars[team].filter(c => !calcChar(c).isDead);
    }
    
    function getActiveEnemies(team) {
      const battleMode = document.getElementById('battle-mode').value;
      const alive = getAliveChars(team);
      
      if (battleMode === 'sequential' && alive.length > 0) {
        return [alive[0]];
      }
      return alive;
    }
    
    function selectTarget(attacker, enemies) {
      const battleMode = document.getElementById('battle-mode').value;
      let alive = enemies.filter(e => !calcChar(e).isDead);
      
      if (battleMode === 'sequential' && alive.length > 0) {
        return alive[0];
      }
      
      if (alive.length === 0) return null;
      
      const mode = document.getElementById('targeting-mode').value;
      if (mode === 'weakest') return alive.reduce((a, b) => a.neigong < b.neigong ? a : b);
      if (mode === 'strongest') return alive.reduce((a, b) => calcChar(a).power > calcChar(b).power ? a : b);
      return randomPick(alive);
    }
    
    function usePotion(char) {
      const c = calcChar(char);
      if (c.isDead) return;
      
      const healAmountHp = parseInt(document.getElementById('potion-heal-hp').value);
      const healAmountNg = parseInt(document.getElementById('potion-heal-ng').value);
      const hpThreshold = parseInt(document.getElementById('hp-threshold').value);
      const ngThreshold = parseInt(document.getElementById('ng-threshold').value);
      
      if (char.hp <= hpThreshold && char.hpPotions > 0) {
        const heal = Math.min(healAmountHp, 100 - char.hp);
        char.hp += heal;
        char.hpPotions--;
        state.totalPotionsUsed++;
        state.hpPotionsUsed++;
        addLogTime(`üíä ${char.name} HP Potion! (+${heal.toFixed(1)}%)`, 'potion');
        char.currentAction = 'HP Potion';
      }
      
      if (char.neigong <= ngThreshold && char.ngPotions > 0) {
        const heal = Math.min(healAmountNg, 100 - char.neigong);
        char.neigong += heal;
        char.ngPotions--;
        state.totalPotionsUsed++;
        state.ngPotionsUsed++;
        addLogTime(`üíä ${char.name} Mana Potion! (+${heal.toFixed(1)}%)`, 'potion');
        char.currentAction = 'Mana Potion';
      }
    }
      
function processAttack(attacker, defender) {
      const atkCalc = calcChar(attacker);
      const defCalc = calcChar(defender);
      
      if (atkCalc.isDead || defCalc.isDead) return;
      
      state.attackCount++;
      
      if (attacker.lastTarget === defender.id) attacker.comboCount++;
      else { attacker.comboCount = 1; attacker.lastTarget = defender.id; }
      
      const selectedMugong = selectMugong(attacker, defender);
      
      const costMult = getMultipliers();
      const neigongTotal = atkCalc.g.neigong * costMult.neigong;
      const mugongCost = selectedMugong.mugongCost + selectedMugong.balchulCost;
      const costPercent = (mugongCost / neigongTotal) * 100;
      
      if (attacker.neigong < costPercent + atkCalc.threshold) {
        addLogTime(`${attacker.name}: Mana depleted!`, 'critical');
        attacker.ungi = 0;
        return;
      }
      attacker.neigong -= costPercent;
      
      const missNgThreshold = parseInt(document.getElementById('miss-ng-threshold')?.value || 50);
      let missChance = 0;
      if (attacker.neigong <= missNgThreshold) {
        missChance = 5 + (missNgThreshold - attacker.neigong) * 5;
      }
      
      const hpPenaltyThreshold = parseInt(document.getElementById('hp-penalty-threshold')?.value || 80);
      const hpPenaltyInit = 3 / 100;
      const hpPenaltyPerPercent = 1 / 100;
      let hpPenalty = 0;
      if (attacker.hp <= hpPenaltyThreshold) {
        hpPenalty = hpPenaltyInit + (hpPenaltyThreshold - attacker.hp) * hpPenaltyPerPercent;
      }
      
      if (missChance > 0 && Math.random() * 100 < missChance) {
        addLog(`‚îÅ‚îÅ Round ${state.attackCount}: ${attacker.name} ‚Üí ${defender.name} ‚îÅ‚îÅ`, 'divider');
        addLogTime(`${attacker.name}'s spell missed! (Hit -${missChance.toFixed(0)}%)`, 'naesang');
        
        const dmgSplit = getDamageSplit();
        const atkRemain = 100 - attacker.ungi;
        const atkStabReduce = 1 - (atkCalc.s.stab / 500);
        const atkDefBonus = selectedMugong.mugongBonus;
        const atkNaesang = atkRemain * atkCalc.danger * atkStabReduce * (1 - atkDefBonus);
        attacker.hp -= atkNaesang * dmgSplit.hp;
        attacker.neigong -= atkNaesang * dmgSplit.ng;
        if (atkNaesang > 0.5) addLogTime(`  ${attacker.name} Backlash -${atkNaesang.toFixed(1)} (Wasted)`, 'naesang');
        
        attacker.ungi = 0;
        const atkBobeop = attacker.bobeop || 0;
        const retreatTime = Math.max(1, 5 - atkBobeop * 0.4);
        attacker.cooldown = retreatTime;
        attacker.currentAction = 'Recovering';
        return;
      }
      
      const atkDir = randomPick(APPROACH_DIR);
      const defDir = randomPick(DIRECTIONS);
      let dirBonus = 0;
      if (atkDir === 'Forward') dirBonus += 0.10;
      else dirBonus += 0.08;
      if (RETREAT_DIR.includes(defDir)) dirBonus += 0.10;
      
      const comboBonus = COMBO_BONUS[Math.min(4, attacker.comboCount)] || 0;
      const atkUngi = attacker.ungi;
      const defUngi = defender.ungi;
      
      addLog(`‚îÅ‚îÅ Round ${state.attackCount}: ${attacker.name} ‚Üí ${defender.name} ‚îÅ‚îÅ`, 'divider');
      
      addLogTime(`${attacker.name}, ${atkDir}!`, 'move');
      attacker.currentAction = `${atkDir} Approach`;
      defender.currentAction = `${defDir} Response`;
      
      const usesBalchul = selectedMugong.balchul !== 'None' && Math.random() > 0.5;
      if (usesBalchul) {
        addLogTime(`${attacker.name}'s ${selectedMugong.balchul}‚îÄ„Äå${BALCHUL_DESC[selectedMugong.balchul]}„Äç`, 'attack');
        attacker.currentAction = selectedMugong.balchul;
      } else {
        const atkType = randomPick(ATTACK_TYPES[selectedMugong.mugong]);
        addLogTime(`${attacker.name}'s ${selectedMugong.mugong} ${LEVEL_NAME[selectedMugong.mugongLv]}‚îÄ„Äå${atkType}„Äç`, 'attack');
        attacker.currentAction = atkType;
      }
      
      const defend = randomPick(DEFEND_TYPES);
      addLogTime(`${defender.name}, ${defend}!`, 'defend');
      defender.currentAction = defend;
      
      const dmgSplit = getDamageSplit();
      const atkRemain = 100 - atkUngi;
      const defRemain = 100 - defUngi;
      
      const atkStabReduce = 1 - (atkCalc.s.stab / 500);
      const defStabReduce = 1 - (defCalc.s.stab / 500);
      
      const atkDefBonus = usesBalchul ? selectedMugong.balchulBonus : selectedMugong.mugongBonus;
      const defMugong = MUGONG[defender.mugong]?.[defender.mugongLv] || [0, 0];
      const defDefBonus = defMugong[0] / 100;
      
      if (atkUngi < 100) {
        const atkNaesang = atkRemain * atkCalc.danger * atkStabReduce * (1 - atkDefBonus);
        attacker.hp -= atkNaesang * dmgSplit.hp;
        attacker.neigong -= atkNaesang * dmgSplit.ng;
        if (atkNaesang > 0.5) addLogTime(`  ${attacker.name} Backlash -${atkNaesang.toFixed(1)} (Def${(atkDefBonus*100).toFixed(0)}%)`, 'naesang');
      }
      
      const defNaesang = defRemain * defCalc.danger * defStabReduce * (1 - defDefBonus);
      defender.hp -= defNaesang * dmgSplit.hp;
      defender.neigong -= defNaesang * dmgSplit.ng;
      if (defNaesang > 0.5) addLogTime(`  ${defender.name} Backlash -${defNaesang.toFixed(1)} (Def${(defDefBonus*100).toFixed(0)}%)`, 'naesang');
      
      const mult = getMultipliers();
      
      const levelDiff = atkCalc.g.level - defCalc.g.level;
      let gyeongjiPenalty = levelDiff < 0 ? levelDiff * 0.03 : 0;
      
      const simbeopDiff = atkCalc.s.tier - defCalc.s.tier;
      let simbeopPenalty = simbeopDiff < 0 ? simbeopDiff * 0.03 : 0;
      
      let modifier = (1 + gyeongjiPenalty + simbeopPenalty) * (1 - hpPenalty);
      
      const mugongBonus = usesBalchul ? selectedMugong.balchulBonus : selectedMugong.mugongBonus;
      const totalBonus = atkCalc.bobeopBonus + mugongBonus + dirBonus + comboBonus;
      
      const defNeigongTotal = defCalc.g.neigong * mult.neigong;
      const defHpTotal = defCalc.g.neigong * mult.hp;
      
      const baseDamage = atkCalc.power * modifier;
      const totalDamage = baseDamage * (1 + totalBonus);
      
      const ngDmgPercent = (totalDamage / defNeigongTotal) * 100;
      const hpDmgPercent = (totalDamage / defHpTotal) * 100;
      
      defender.hp -= hpDmgPercent * dmgSplit.hp;
      defender.neigong -= ngDmgPercent * dmgSplit.ng;
      
      let bonusDesc = [];
      if (atkCalc.bobeopBonus > 0) bonusDesc.push(`Shield+${(atkCalc.bobeopBonus*100).toFixed(0)}%`);
      if (mugongBonus > 0) bonusDesc.push(`Spell+${(mugongBonus*100).toFixed(0)}%`);
      if (dirBonus > 0) bonusDesc.push(`Move+${(dirBonus*100).toFixed(0)}%`);
      if (comboBonus > 0) bonusDesc.push(`${attacker.comboCount}Combo+${(comboBonus*100).toFixed(0)}%`);
      if (gyeongjiPenalty < 0) bonusDesc.push(`Circle${(gyeongjiPenalty*100).toFixed(0)}%`);
      if (simbeopPenalty < 0) bonusDesc.push(`Meditation${(simbeopPenalty*100).toFixed(0)}%`);
      if (hpPenalty > 0) bonusDesc.push(`HP‚Üì${(hpPenalty*100).toFixed(0)}%`);
      
      if (bonusDesc.length > 0) addLogTime(`  [${bonusDesc.join(', ')}]`, 'combo');
      addLogTime(`  ‚öîÔ∏è HP-${(hpDmgPercent * dmgSplit.hp).toFixed(1)}%, Mana-${(ngDmgPercent * dmgSplit.ng).toFixed(1)}%`, 'damage');
      
      [attacker, defender].forEach(c => {
        c.hp = Math.max(0, c.hp);
        c.neigong = Math.max(0, c.neigong);
      });
      
      const atkBobeop = attacker.bobeop || 0;
      const retreatTime = Math.max(1, 5 - atkBobeop * 0.4);
      attacker.ungi = 0;
      attacker.cooldown = retreatTime;
      attacker.currentAction = 'Recovering';
      addLogTime(`  ‚Ü©Ô∏è ${attacker.name} Recovery (${retreatTime.toFixed(1)}s)`, 'move');
      
      if (calcChar(defender).isDead) {
        addLogTime(`üíÄ ${defender.name} Knocked Out!`, 'critical');
        
        const battleMode = document.getElementById('battle-mode').value;
        if (battleMode === 'sequential' && defender.team === 'enemy') {
          const remainingEnemies = getAliveChars('enemy');
          if (remainingEnemies.length > 0) {
            addLogTime(`‚û°Ô∏è Next: ${remainingEnemies[0].name} enters! (${remainingEnemies.length} left)`, 'ready');
          }
        }
      }
      if (calcChar(attacker).isDead) {
        addLogTime(`üíÄ ${attacker.name} collapsed from backlash!`, 'critical');
      }
    }
      
function gameLoop(timestamp) {
      if (!state.running) return;
      
      const speed = parseFloat(document.getElementById('sim-speed').value);
      if (state.lastTime === 0) state.lastTime = timestamp;
      
      const delta = (timestamp - state.lastTime) / 1000 * speed;
      state.lastTime = timestamp;
      state.time += delta;
      
      const battleMode = document.getElementById('battle-mode').value;
      const activeEnemies = battleMode === 'sequential' 
        ? getActiveEnemies('enemy')
        : state.chars.enemy;
      
      [...state.chars.ally, ...state.chars.enemy].forEach(char => {
        const c = calcChar(char);
        
        if (battleMode === 'sequential' && char.team === 'enemy') {
          if (!activeEnemies.includes(char)) {
            if (!c.isDead) char.currentAction = 'Waiting (Sequential)';
            return;
          }
        }
        
        if (!c.isDead) {
          if (char.cooldown > 0) {
            char.cooldown = Math.max(0, char.cooldown - delta);
            if (char.cooldown <= 0) {
              char.currentAction = 'Waiting';
            }
          }
          
          if (char.cooldown <= 0) {
            char.ungi += c.ungiPerSec * delta;
            char.ungi = Math.min(100, char.ungi);
            if (char.ungi < 80) char.currentAction = `Energy ${char.ungi.toFixed(0)}%`;
          }
          
          usePotion(char);
        }
      });
      
      let combatants = [...state.chars.ally];
      if (battleMode === 'sequential') {
        combatants = [...combatants, ...activeEnemies];
      } else {
        combatants = [...combatants, ...state.chars.enemy];
      }
      
      const readyChars = combatants
        .filter(c => c.ungi >= 80 && c.cooldown <= 0 && !calcChar(c).isDead)
        .map(c => ({ char: c, calc: calcChar(c) }))
        .sort((a, b) => {
          if (b.calc.moveSpeed !== a.calc.moveSpeed) return b.calc.moveSpeed - a.calc.moveSpeed;
          return a.calc.atkTime - b.calc.atkTime;
        });
      
      if (readyChars.length > 0) {
        const attacker = readyChars[0].char;
        const enemies = attacker.team === 'ally' ? state.chars.enemy : state.chars.ally;
        const target = selectTarget(attacker, enemies);
        
        if (target) {
          processAttack(attacker, target);
        }
      }
      
      renderAll();
      
      const allyAlive = getAliveChars('ally').length;
      const enemyAlive = getAliveChars('enemy').length;
      
      if (allyAlive === 0 || enemyAlive === 0) {
        if (allyAlive === 0 && enemyAlive === 0) {
          state.winner = 'draw';
          endBattle('‚öîÔ∏è Mutual Annihilation!');
        } else if (allyAlive === 0) {
          state.winner = 'enemy';
          endBattle(`üèÜ Enemy Victory! (${state.time.toFixed(1)}s, ${state.attackCount} rounds)`);
        } else {
          state.winner = 'ally';
          endBattle(`üèÜ Ally Victory! (${state.time.toFixed(1)}s, ${state.attackCount} rounds)`);
        }
        return;
      }
      
      state.animFrame = requestAnimationFrame(gameLoop);
    }
    
    function startBattle() {
      const allyCount = state.chars.ally.length;
      const enemyCount = state.chars.enemy.length;
      
      if (allyCount === 0 || enemyCount === 0) {
        alert('Place at least 1 character on each team!');
        return;
      }
      
      if (state.running) return;
      state.running = true;
      state.lastTime = 0;
      
      const allyMaxTier = Math.max(...state.chars.ally.map(c => SIMBEOP[c.simbeop]?.tier || 0));
      const enemyMaxTier = Math.max(...state.chars.enemy.map(c => SIMBEOP[c.simbeop]?.tier || 0));
      
      state.chars.ally.forEach(char => {
        const myTier = SIMBEOP[char.simbeop]?.tier || 0;
        const diff = myTier - enemyMaxTier;
        char.speedPenalty = diff < 0 ? diff * 0.03 : 0;
      });
      
      state.chars.enemy.forEach(char => {
        const myTier = SIMBEOP[char.simbeop]?.tier || 0;
        const diff = myTier - allyMaxTier;
        char.speedPenalty = diff < 0 ? diff * 0.03 : 0;
      });
      
      document.getElementById('btn-start').style.display = 'none';
      document.getElementById('btn-stop').style.display = 'inline-block';
      updateAddButtons();
      
      if (state.time === 0) {
        document.getElementById('log-content').innerHTML = '';
        
        const battleMode = document.getElementById('battle-mode').value;
        if (battleMode === 'sequential') {
          addLog(`‚îÅ‚îÅ‚îÅ Sequential Battle: ${allyCount} vs ${enemyCount} (Solo) ‚îÅ‚îÅ‚îÅ`, 'divider');
          addLogTime(`üéØ First Target: ${state.chars.enemy[0].name}`, 'ready');
        } else {
          addLog(`‚îÅ‚îÅ‚îÅ Simultaneous Battle: ${allyCount} vs ${enemyCount} ‚îÅ‚îÅ‚îÅ`, 'divider');
        }
        
        [...state.chars.ally, ...state.chars.enemy].forEach(char => {
          if (char.speedPenalty < 0) {
            addLogTime(`‚ö†Ô∏è ${char.name}: Meditation disadvantage (Speed ${(char.speedPenalty*100).toFixed(0)}%)`, 'naesang');
          }
        });
        
        addLogTime('Both sides glare at each other...', 'info');
        addLogTime('Energy gathering begins!', 'ready');
      }
      
      renderAll();
      state.animFrame = requestAnimationFrame(gameLoop);
    }
    
    function stopBattle() {
      state.running = false;
      state.lastTime = 0;
      if (state.animFrame) cancelAnimationFrame(state.animFrame);
      
      document.getElementById('btn-start').style.display = 'inline-block';
      document.getElementById('btn-stop').style.display = 'none';
      
      addLogTime('Battle paused', 'info');
      renderAll();
    }
    
    function endBattle(resultText) {
      state.running = false;
      if (state.animFrame) cancelAnimationFrame(state.animFrame);
      
      document.getElementById('btn-start').style.display = 'none';
      document.getElementById('btn-stop').style.display = 'none';
      
      document.getElementById('battle-result').style.display = 'block';
      document.getElementById('result-text').textContent = resultText;
      
      addLog('‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ', 'divider');
      addLog(resultText, 'ready');
      
      if (state.totalPotionsUsed > 0) {
        addLog(`üíä Potions Used: HP ${state.hpPotionsUsed} / Mana ${state.ngPotionsUsed} (Total ${state.totalPotionsUsed})`, 'potion');
      }
      
      renderAll();
    }
    
    function resetBattle() {
      stopBattle();
      
      state.time = 0;
      state.attackCount = 0;
      state.winner = null;
      state.totalPotionsUsed = 0;
      state.hpPotionsUsed = 0;
      state.ngPotionsUsed = 0;
      
      [...state.chars.ally, ...state.chars.enemy].forEach(char => {
        char.hp = 100;
        char.neigong = 100;
        char.ungi = 0;
        char.cooldown = 0;
        char.speedPenalty = 0;
        char.currentAction = 'Waiting';
        char.comboCount = 0;
        char.lastTarget = null;
      });
      
      document.getElementById('btn-start').style.display = 'inline-block';
      document.getElementById('btn-stop').style.display = 'none';
      document.getElementById('battle-result').style.display = 'none';
      
      updateAddButtons();
      
      document.getElementById('log-content').innerHTML = `
        <div class="log-line info">Place characters and start battle.</div>
        <div class="log-line info">Up to 5 vs 5 supported.</div>
      `;
      
      renderAll();
    }
    
    function init() {
      state.chars.ally.push(createCharacter('ally', {
        name: 'Archmage', gyeongji: '4-Circle', simbeop: 'Adept Meditation',
        mugong: 'Blast', mugongLv: 1, bobeop: 5,
        balchul: 'Quick Cast', balchulLv: 2,
        hpPotions: 5, ngPotions: 5
      }));
      
      state.chars.enemy.push(createCharacter('enemy', {
        name: 'Bandit Leader', gyeongji: '3-Circle', simbeop: 'Apprentice Meditation',
        mugong: 'Bolt', mugongLv: 2, bobeop: 3,
        balchul: 'Quick Cast', balchulLv: 1,
        hpPotions: 2, ngPotions: 2
      }));
      state.chars.enemy.push(createCharacter('enemy', {
        name: 'Bandit 1', gyeongji: '2-Circle', simbeop: 'Apprentice Meditation',
        mugong: 'Spark', mugongLv: 2, bobeop: 2,
        balchul: 'None', balchulLv: 1,
        hpPotions: 1, ngPotions: 1
      }));
      state.chars.enemy.push(createCharacter('enemy', {
        name: 'Bandit 2', gyeongji: '1-Circle', simbeop: 'Basic Meditation',
        mugong: 'Spark', mugongLv: 1, bobeop: 1,
        balchul: 'None', balchulLv: 1,
        hpPotions: 1, ngPotions: 1
      }));
      
      renderAll();
      updateAddButtons();
    }
    
    init();
  </script>
</body>
</html>

      </div></div>
</body>
</html>